<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <title>Morphdoc</title>
  </head>
  <body>
    <div contenteditable="true" spellcheck="false" id="main">
      <div>Morphdoc v0.0.1</div><div><br /></div><div>#About<br />Morphdoc is Editable/Standalone/Text-based/Interactive/Light document system.<br />It is build on pure HTML5/JavaScript with support of Native FileSystem API.</div><div><br /></div><div>#Usage<br />- Ctrl+S to overwrite.<br />- Ctrl+Shift+S to write to another file.</div><div><br /></div><div>#Issues<br /></div>
    </div>




</body>
<style id="mpdStyle">
  div {
    outline: none;
  }

  #main > div {
    border-bottom: solid 1px #CCC;
  }

  * {
    font-size: small;
  }
</style>
<script id="mpdScript">

let globalOverwriteTimeout = null;
let globalFSHandle;

function addLog(str) {
  console.log(str);
}

async function _writeFile(fileHandle, contents) {
  const writable = await fileHandle.createWritable();
  // await writable.truncate(0);
  await writable.write(contents);
  await writable.close();
}

async function saveFile(contents, handle = null) {
  try {
    if (!handle) {
      handle = await window.showSaveFilePicker({
        types: [
          {
            description: "HTML Files",
            accept: {
              "text/html": [".html"],
            },
          },
        ],
      });
    }
    await _writeFile(handle, contents);
    return handle;
  } catch (ex) {
    const msg = "failed to save";
    console.error(msg, ex);
    return false;
  }
}

async function openFile() {
  const result = {
    handle: null,
    text: ""
  };

  /** @type FileSystemHandle */
  let fileHandle;
  try {
    [fileHandle] = await window.showOpenFilePicker({
      types: [
        {
          description: "HTML Files",
          accept: {
            "text/html": [".html"],
          },
        },
      ],
    });
    result.handle = fileHandle;
  } catch (ex) {
    console.error("failed to fetch file", ex);
    return false;
  }

  const file = await fileHandle.getFile();
  try {
    const text = await file.text();
    result.text = text;
    return result;
  } catch (ex) {
    console.error("failed to get content", ex);
    return false;
  }
}

function isNativeFileSystemSupported() {
  // eslint-disable-next-line no-undef
  return "showOpenFilePicker" in window;
}

function serializeSource() {
  const xs = new XMLSerializer();
  const dp = new DOMParser();
  
  const dom = dp.parseFromString(xs.serializeToString(document), "text/html");
  dom.getElementById("mpdStyle").remove();
  dom.getElementById("mpdScript").remove();
  return xs.serializeToString(dom)
    .replace('<\/html>',
      "\n"
      + `<style id="mpdStyle">` + document.getElementById("mpdStyle").innerHTML + `<\/style>`
      + "\n"
      + `<script id="mpdScript">` + document.getElementById("mpdScript").innerHTML + `<\/script>`
      + "\n"
      + `<\/html>`);
}

async function overwrite() {
  if (!nativeFSSupported) {
    return;
  }

  if(!globalFSHandle) {
    return;
  }

  clearTimeout(globalOverwriteTimeout);
  globalOverwriteTimeout = setTimeout(async function() {
      const fsHandle = await saveFile(
        serializeSource(),
        globalFSHandle
      );
      if (fsHandle) {
        globalFSHandle = fsHandle;
        addLog("saved");
      } else {
        addLog("failed to save");
      }
    },
    3000);
}

document.getElementById("main").addEventListener("input", function() {
  overwrite();
});

document.addEventListener("keydown", async (e) => {
  if (e.ctrlKey && e.shiftKey && e.code === "KeyS") {
    e.preventDefault();
    if (!nativeFSSupported) {
      alert("nfs not supported");
      return;
    }

    const fsHandle = await saveFile(
      serializeSource(),
      null
    );
    if (fsHandle) {
      globalFSHandle = fsHandle;
      addLog("saved");
    } else {
      addLog("failed to save");
    }
  } else if (e.ctrlKey && e.code === "KeyS") {
    e.preventDefault();
    if (!nativeFSSupported) {
      alert("nfs not supported");
      return;
    }

    const fsHandle = await saveFile(
      serializeSource(),
      globalFSHandle
    );
    if (fsHandle) {
      globalFSHandle = fsHandle;
      addLog("saved");
    } else {
      addLog("failed to save");
    }
  } else if (e.ctrlKey && e.code === "KeyO") {
    e.preventDefault();
    if (!nativeFSSupported) {
      alert("nfs not supported");
      return;
    }

    const res = await openFile();
    if (res) {
      globalFSHandle = res.handle;
      document.getElementById("content").value = res.text;
      addLog("file opened");
    } else {
      addLog("failed to open file");
    }
  }
});

const nativeFSSupported = isNativeFileSystemSupported();
addLog(`support for nfs: ${(nativeFSSupported) ? "yes" : "no"}`);
</script>
</html>